<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\DB;
use App\Models\Admin;
use App\Models\User;
use App\Models\Candidat;
use App\Models\Vote;
use App\Models\Lists;

class AdminController extends Controller
{
    //=======================================================
    // MODULE 1: AUTHENTIFICATION ADMIN
    //=======================================================
    
    /**
     * Afficher la page d'authentification admin.
     */
    public function afficherPageAuthAdmin()
    {
        return view('authentificationadmin');
    }

    /**
     * G√©rer la connexion de l'admin.
     */
    public function login(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'password' => 'required'
        ]);

        $credentials = $request->only('email', 'password');

        if (Auth::guard('admin')->attempt($credentials)) {
            $request->session()->regenerate();
            return redirect()->intended(route('pageAcceuilAdmin'));
        }

        return back()->withErrors([
            'email' => 'Identifiants incorrects.',
        ])->onlyInput('email');
    }

    /**
     * D√©connecter l'admin.
     */
    public function logout(Request $request)
    {
        Auth::guard('admin')->logout(); // D√©connexion de l'admin
        $request->session()->invalidate(); // Invalide la session
        $request->session()->regenerateToken(); // R√©g√©n√®re le token CSRF pour √©viter les attaques

        return redirect('/pageAuthAdmin'); // Redirige vers la page de connexion de l'admin
    }

    //=======================================================
    // MODULE 2: TABLEAU DE BORD ADMIN
    //=======================================================
    
    /**
     * Afficher la page d'accueil admin avec des donn√©es dynamiques
     */
    public function afficherPageAcceuilAdmin()
    {
        try {
            // R√©cup√©rer les statistiques de base
            $stats = [
                'totalEtudiants' => User::count(),
                'totalListes' => Lists::count(),
                'totalCandidats' => Candidat::count(),
                'totalVotes' => Vote::count(),
            ];

            // R√©cup√©rer les activit√©s r√©centes
            $activitesRecent = $this->getRecentActivities();

            return view('acceuiladminutilisateur', array_merge($stats, [
                'activitesRecent' => $activitesRecent,
            ]));

        } catch (\Exception $e) {
            Log::error('Erreur dans afficherPageAcceuilAdmin: ' . $e->getMessage());
            return back()->with('error', 'Une erreur est survenue lors du chargement du tableau de bord.');
        }
    }

    /**
     * R√©cup√©rer les activit√©s r√©centes pour le tableau de bord
     */
    private function getRecentActivities()
    {
        $activities = collect();

        // Inscriptions r√©centes
        User::latest()->take(5)->get()->each(function ($user) use ($activities) {
            $activities->push([
                'description' => "Nouvel utilisateur inscrit : {$user->prenom} {$user->nom}",
                'date' => $user->created_at,
                'icon' => 'üë§'
            ]);
        });

        // Votes r√©cents
        Vote::with(['user', 'candidat.list'])
            ->latest()
            ->take(5)
            ->get()
            ->each(function ($vote) use ($activities) {
                $activities->push([
                    'description' => "{$vote->user->prenom} {$vote->user->nom} a vot√© pour la liste " . ($vote->candidat->list->nom_liste ?? 'Inconnue'),
                    'date' => $vote->created_at,
                    'icon' => 'üó≥Ô∏è'
                ]);
            });

        // Listes r√©centes
        Lists::latest()->take(5)->get()->each(function ($liste) use ($activities) {
            $activities->push([
                'description' => "Nouvelle liste cr√©√©e : {$liste->nom_liste}",
                'date' => $liste->created_at,
                'icon' => 'üìã'
            ]);
        });

        return $activities->sortByDesc('date')->take(10);
    }

    //=======================================================
    // MODULE 3: GESTION DES UTILISATEURS
    //=======================================================
    
    /**
     * Afficher la page de gestion des utilisateurs.
     */
    public function gestionUtilisateurs()
    {
        // R√©cup√©rer tous les utilisateurs
        $utilisateurs = User::all();

        // D√©finir le filtre par d√©faut
        $filtre = 'tous';

        // Par d√©faut, la modification n'est pas active
        $modificationActive = false;

        // Passer les utilisateurs, le filtre et l'√©tat de modification √† la vue
        return view('gestionutilisateurs', [
            'utilisateurs' => $utilisateurs,
            'filtre' => $filtre,
            'modificationActive' => $modificationActive,
        ]);
    }

    /**
     * Filtrer les utilisateurs en fonction du statut (actifs, d√©sactiv√©s, tous).
     */
    public function filtrerUtilisateurs(Request $request)
    {
        // R√©cup√©rer le filtre depuis la requ√™te AJAX
        $filtre = $request->input('filtre');

        // Filtrer les utilisateurs en fonction du filtre
        $utilisateurs = User::query();

        switch ($filtre) {
            case 'actifs':
                $utilisateurs->where('is_active', true);
                break;
            case 'desactives':
                $utilisateurs->where('is_active', false);
                break;
            // Par d√©faut, afficher tous les utilisateurs
        }

        // R√©cup√©rer les utilisateurs filtr√©s
        $utilisateurs = $utilisateurs->get();

        // Retourner la vue partielle avec les utilisateurs filtr√©s et le filtre actuel
        return view('partials.utilisateurs_table', [
            'utilisateurs' => $utilisateurs,
            'filtre' => $filtre,
            'modificationActive' => false, // La modification n'est pas active par d√©faut
        ]);
    }

    /**
     * Valider les modifications des utilisateurs (activation/d√©sactivation).
     */
    public function validerModifications(Request $request)
    {
        // Valider les donn√©es re√ßues
        $request->validate([
            'utilisateurs' => 'required|array',
            'utilisateurs.*.id' => 'required|integer',
            'utilisateurs.*.is_active' => 'required|in:0,1,true,false', // Accepter 0, 1, true, false
        ]);

        // Mettre √† jour chaque utilisateur
        foreach ($request->utilisateurs as $utilisateur) {
            // Convertir 'true'/'false' en 1/0 si n√©cessaire
            $isActive = filter_var($utilisateur['is_active'], FILTER_VALIDATE_BOOLEAN); // Convertit en bool√©en
            $isActive = $isActive ? 1 : 0; // Convertit en 1 ou 0

            User::where('id', $utilisateur['id'])->update([
                'is_active' => $isActive,
            ]);
        }

        // Retourner une r√©ponse JSON pour AJAX
        return response()->json([
            'success' => true,
            'message' => 'Modifications enregistr√©es avec succ√®s !',
        ]);
    }

    //=======================================================
    // MODULE 4: GESTION DES LISTES
    //=======================================================
    
    /**
     * Afficher la page de gestion des listes.
     */
    public function gestionListes()
    {
        $lists = Lists::all(); // R√©cup√©rer toutes les listes
        return view('gestionlistes', compact('lists'));
    }

    /**
     * Afficher le formulaire de cr√©ation d'une liste.
     */
    public function createListe()
    {
        return view('lists.create');
    }

    /**
     * Enregistrer une nouvelle liste.
     */
    public function storeListe(Request $request)
    {
        Log::info('D√©but de la fonction storeListe');

        // Valider les donn√©es re√ßues
        $validator = Validator::make($request->all(), [
            'nom_liste' => 'required|string|max:255',
            'description' => 'required|string',
            'is_active' => 'required|boolean',
            'code_etu_info_licence' => 'required|string|max:255',
            'code_etu_info_master' => 'required|string|max:255',
            'code_etu_math_licence' => 'required|string|max:255',
            'code_etu_math_master' => 'required|string|max:255',
            'code_etu_phys_licence' => 'required|string|max:255',
            'code_etu_phys_master' => 'required|string|max:255',
            'code_etu_conseil_licence' => 'required|string|max:255',
            'code_etu_conseil_master' => 'required|string|max:255',
        ]);

        // Si la validation √©choue, renvoyer les erreurs en JSON
        if ($validator->fails()) {
            Log::info('Validation √©chou√©e', $validator->errors()->toArray());
            return response()->json([
                'errors' => $validator->errors(),
            ], 422);
        }

        // R√©cup√©rer tous les codes √©tudiants pour les postes de d√©partement
        $codesDepartement = [
            $request->code_etu_info_licence,
            $request->code_etu_info_master,
            $request->code_etu_math_licence,
            $request->code_etu_math_master,
            $request->code_etu_phys_licence,
            $request->code_etu_phys_master,
        ];

        // V√©rifier si un candidat de conseil est d√©j√† dans un d√©partement
        if (in_array($request->code_etu_conseil_licence, $codesDepartement)) {
            Log::info('Candidat d√©j√† dans un d√©partement (Conseil Licence)');
            return response()->json([
                'errors' => [
                    'code_etu_conseil_licence' => ['Ce candidat est d√©j√† assign√© √† un poste de d√©partement.']
                ],
            ], 422);
        }

        if (in_array($request->code_etu_conseil_master, $codesDepartement)) {
            Log::info('Candidat d√©j√† dans un d√©partement (Conseil Master)');
            return response()->json([
                'errors' => [
                    'code_etu_conseil_master' => ['Ce candidat est d√©j√† assign√© √† un poste de d√©partement.']
                ],
            ], 422);
        }

        // D√©finir les candidats avec leurs crit√®res de validation
        $codesEtudiants = [
            'info_licence' => [
                'code' => $request->code_etu_info_licence,
                'departement' => 'Informatique',
                'niveau' => 'Licence',
            ],
            'info_master' => [
                'code' => $request->code_etu_info_master,
                'departement' => 'Informatique',
                'niveau' => 'Master',
            ],
            'math_licence' => [
                'code' => $request->code_etu_math_licence,
                'departement' => 'Mathematique',
                'niveau' => 'Licence',
            ],
            'math_master' => [
                'code' => $request->code_etu_math_master,
                'departement' => 'Mathematique',
                'niveau' => 'Master',
            ],
            'phys_licence' => [
                'code' => $request->code_etu_phys_licence,
                'departement' => 'Physique',
                'niveau' => 'Licence',
            ],
            'phys_master' => [
                'code' => $request->code_etu_phys_master,
                'departement' => 'Physique',
                'niveau' => 'Master',
            ],
            'conseil_licence' => [
                'code' => $request->code_etu_conseil_licence,
                'departement' => null, // Conseil n'est pas li√© √† un d√©partement
                'niveau' => 'Licence',
            ],
            'conseil_master' => [
                'code' => $request->code_etu_conseil_master,
                'departement' => null, // Conseil n'est pas li√© √† un d√©partement
                'niveau' => 'Master',
            ],
        ];

        // V√©rifier chaque candidat
        foreach ($codesEtudiants as $type => $data) {
            $etudiant = User::where('code_etudiant', $data['code'])
                            ->where('is_active', true)
                            ->when($data['departement'], function ($query, $departement) {
                                return $query->where('departement', $departement);
                            })
                            ->where('niveau', $data['niveau'])
                            ->first();

            if (!$etudiant) {
                $message = "Le code √©tudiant {$data['code']} ne correspond pas ";
                $message .= $data['departement'] ? "au d√©partement {$data['departement']} ou " : "";
                $message .= "au niveau {$data['niveau']} requis.";

                Log::info('Code √©tudiant invalide', ['type' => $type, 'message' => $message]);
                return response()->json([
                    'errors' => [
                        'code_etu_' . $type => [$message],
                    ],
                ], 422);
            }
        }

        // Cr√©er la liste
        $list = Lists::create($request->all());

        // Remplir la table `candidats`
        foreach ($codesEtudiants as $type => $data) {
            Candidat::create([
                'code_etudiant' => $data['code'],
                'type_candidat' => str_contains($type, 'conseil') ? 'conseil' : 'departement',
                'list_id' => $list->id,
                'is_active' => true,
                'votes_count' => 0,
            ]);
        }

        Log::info('Liste cr√©√©e avec succ√®s');

        // Renvoyer une r√©ponse JSON en cas de succ√®s
        return response()->json([
            'success' => true,
            'message' => 'Liste cr√©√©e avec succ√®s !',
        ]);
    }

    /**
     * Afficher le formulaire de modification d'une liste.
     */
    public function editListe($id)
    {
        $list = Lists::findOrFail($id); // R√©cup√©rer la liste par son ID
        return view('lists.edit', compact('list'));
    }

    /**
     * Mettre √† jour une liste existante.
     */
    public function updateListe(Request $request, $id)
    {
        $request->validate([
            'nom_liste' => 'required|string|max:255',
            'description' => 'required|string',
            'is_active' => 'required|boolean',
        ]);

        $list = Lists::findOrFail($id);
        $list->update($request->all());

        return redirect()->route('gestion.listes')->with('success', 'Liste mise √† jour avec succ√®s !');
    }

    /**
     * Supprimer une liste.
     */
    public function destroyListe($id)
    {
        $list = Lists::findOrFail($id);
        $list->delete();

        return redirect()->route('gestion.listes')->with('success', 'Liste supprim√©e avec succ√®s !');
    }

    //=======================================================
    // MODULE 5: CONSULTATION DES VOTES ET STATISTIQUES
    //=======================================================
    
    /**
     * Afficher la page de consultation des votes avec filtres.
     */
    public function consulterVotes(Request $request)
    {
        // D√©finir des options par d√©faut avec "all" inclus
        $departements = ['all', 'Informatique', 'Mathematique', 'Physique'];
        $niveaux = ['all', 'Licence', 'Master'];

        $vue = $request->input('vue', 'departement');
        
        // Initialiser les variables
        $votes_departement = [];
        $votes_conseil = [];
        $stats = null;
        
        // R√©cup√©ration des donn√©es selon la vue s√©lectionn√©e
        switch($vue) {
            case 'departement':
                $votes_departement = $this->getVotesDepartement([
                    'departement' => $request->input('departement', 'all'),
                    'niveau' => $request->input('niveau', 'all')
                ]);
                break;
                
            case 'conseil':
                $votes_conseil = $this->getVotesConseil([
                    'niveau' => $request->input('niveau', 'all')
                ]);
                break;
                
            case 'statistiques':
                $stats = $this->getVotesStatistics();
                break;
        }
        
        return view('consultervotes', [
            'vue_active' => $vue,
            'filters' => [
                'departement' => $request->input('departement', 'all'),
                'niveau' => $request->input('niveau', 'all')
            ],
            'departements' => $departements,
            'niveaux' => $niveaux,
            'votes_departement' => $votes_departement,
            'votes_conseil' => $votes_conseil,
            'stats' => $stats
        ]);
    }

    /**
     * R√©cup√©rer les votes par d√©partement avec filtres
     */
    protected function getVotesDepartement(array $filters)
    {
        $query = Candidat::with(['user', 'list'])
            ->where('type_candidat', 'departement')
            ->has('list')
            ->withCount('votes');

        // Appliquer les filtres de d√©partement et niveau
        if ($filters['departement'] !== 'all') {
            $query->whereHas('user', fn($q) => $q->where('departement', $filters['departement']));
        }

        if ($filters['niveau'] !== 'all') {
            $query->whereHas('user', fn($q) => $q->where('niveau', $filters['niveau']));
        }

        // Calcul du total des votes APR√àS filtrage
        $totalVotes = clone $query;
        $totalVotes = $totalVotes->get()->sum('votes_count');

        $candidats = $query->get();

        return $candidats->map(function($candidat) use ($totalVotes) {
            return [
                'liste' => $candidat->list->nom_liste ?? 'Liste non sp√©cifi√©e',
                'candidat' => ($candidat->user->prenom ?? '') . ' ' . ($candidat->user->nom ?? ''),
                'departement' => $candidat->user->departement ?? null,
                'niveau' => $candidat->user->niveau ?? null,
                'votes' => $candidat->votes_count,
                'pourcentage' => $totalVotes > 0 ? round(($candidat->votes_count / $totalVotes) * 100, 2) : 0,
            ];
        })->toArray();
    }

    /**
     * R√©cup√©rer les votes pour le conseil avec filtres
     */
    protected function getVotesConseil(array $filters)
    {
        $query = Candidat::with(['user', 'list'])
            ->where('type_candidat', 'conseil')
            ->has('user')
            ->has('list')
            ->withCount('votes');

        if ($filters['niveau'] !== 'all') {
            $query->whereHas('user', function($q) use ($filters) {
                $q->where('niveau', $filters['niveau']);
            });
        }

        // Calcul du total des votes APR√àS filtrage
        $totalVotes = clone $query;
        $totalVotes = $totalVotes->get()->sum('votes_count');

        $candidats = $query->get();

        return $candidats->map(function($candidat) use ($totalVotes) {
            return [
                'liste' => $candidat->list->nom_liste ?? 'Liste inconnue',
                'candidat' => ($candidat->user->prenom ?? '') . ' ' . ($candidat->user->nom ?? ''),
                'niveau' => $candidat->user->niveau ?? 'Niveau inconnu',
                'votes' => $candidat->votes_count,
                'pourcentage' => $totalVotes > 0 ? round(($candidat->votes_count / $totalVotes) * 100, 2) : 0,
            ];
        })->toArray();
    }

    /**
     * R√©cup√©rer les statistiques globales
     */
    protected function getVotesStatistics()
    {
        set_time_limit(120);
        Log::info('D√©but du calcul des statistiques');

        try {
            // Participation globale
            $totalEtudiants = User::count();
            $totalVotants = Vote::select('user_id')->distinct()->count();

            // Stats par d√©partement avec requ√™te optimis√©e
            $departementStats = DB::table('users')
                ->leftJoin('votes', 'users.id', '=', 'votes.user_id')
                ->select('departement')
                ->selectRaw('COUNT(DISTINCT votes.user_id) as count')
                ->groupBy('departement')
                ->get()
                ->mapWithKeys(function($item) use ($totalVotants) {
                    return [
                        $item->departement => [
                            'count' => $item->count,
                            'percentage' => $totalVotants > 0 ? round(($item->count / $totalVotants) * 100, 2) : 0
                        ]
                    ];
                });

            // Stats par niveau avec requ√™te optimis√©e
            $niveauStats = DB::table('users')
                ->leftJoin('votes', 'users.id', '=', 'votes.user_id')
                ->select('niveau')
                ->selectRaw('COUNT(DISTINCT votes.user_id) as count')
                ->groupBy('niveau')
                ->get()
                ->mapWithKeys(function($item) use ($totalVotants) {
                    return [
                        $item->niveau => [
                            'count' => $item->count,
                            'percentage' => $totalVotants > 0 ? round(($item->count / $totalVotants) * 100, 2) : 0
                        ]
                    ];
                });

            // Performance des listes avec requ√™te optimis√©e
            $listesStats = DB::table('lists')
                ->leftJoin('candidats', 'lists.id', '=', 'candidats.list_id')
                ->select('lists.nom_liste')
                ->selectRaw('COALESCE(SUM(candidats.votes_count), 0) as total_votes')
                ->groupBy('lists.nom_liste')
                ->get()
                ->map(function($liste) {
                    return [
                        'liste' => $liste->nom_liste,
                        'votes' => (int)$liste->total_votes
                    ];
                });

            return [
                'participation' => [
                    'percentage' => $totalEtudiants > 0 ? round(($totalVotants / $totalEtudiants) * 100, 2) : 0,
                    'text' => $totalEtudiants > 0 
                        ? round(($totalVotants / $totalEtudiants) * 100, 2).'% ('.$totalVotants.'/'.$totalEtudiants.')' 
                        : '0% (0/0)'
                ],
                'departements' => $departementStats,
                'niveaux' => $niveauStats,
                'listes' => $listesStats
            ];

        } catch (\Exception $e) {
            Log::error('ERREUR STATISTIQUES: ', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return [
                'error' => 'Une erreur est survenue lors du calcul des statistiques',
                'details' => config('app.debug') ? $e->getMessage() : null
            ];
        }
    }
}
